---
title: "Bayesian Linear Regression Project"
author: "Mary Catherine Morrow, Kayla Mota, Summer Dahlen, Shijie Geng"
date: '`r Sys.Date()`'
format:
  html:
    code-fold: true
course: STA 6257 - Advanced Statistical Modeling
bibliography: references.bib # file contains bibtex for references
#always_allow_html: true # this allows to get PDF with HTML features
self-contained: true
execute: 
  warning: false
  message: false
editor: 
  markdown: 
    wrap: 72
---

## 1. Introduction

Bayesian Linear Regression (BLR) is a conditional data analytical method
for understanding the relationship between independent and dependent
variables based on Bayes Theorem while handling uncertainties with
accuracy and interpretability[@walker2007application]. In the prevalent
perspective, the primary method for estimating parameters in a linear
regression model is the frequentist approach. However, this methodology
defines the probability of uncertain events as the relative frequency of
their occurrence[@hajek1996mises], and the resulting model parameters
are derived exclusively from the observed data [@hajek2009fifteen].
Also, when dealing with a small dataset, the frequentist approach may
distort parameter estimates and affect the validity of statistical tests
[@zyphur2015bayesian]. Unlike frequentist method, BLR is a more flexible
statistical model in that it captures all uncertain variables random
[@klauenberg2015tutorial] and also known to be used for experiments that
have small sample sizes [@sugiarto2021determining] and various data
types [@kruschke2010bayesian]. Moreover, BLR eliminates the need for
p-values, offering richer information on parameters, allowing
simultaneous single change point detection in a multivariate sample
[@seidou2007bayesian].

The BLR is characterized by viewing parameters as random variables,
introducing the concept of prior, likelihood, and posterior
distributions [@permai2018linear; @chen2024positional]. The steps for
creating a BLR can be found in Figure. 1 [@klauenberg2015tutorial]. The
BLR method involves multiple steps-essentially, predicting prior values,
imputting collected data, and obtaining probability in the form of a
distribution (Posterior distribution) which is proportional to prior
distribution multiplied by the likelihood function
[@baldwin2017introduction]. In BLR, even when utilizing representative
or informed priors, it is crucial to perform a sensitivity analysis to
assess the impact of different prior specifications on the posterior
results. This aims to ensure that the findings are not dependent on the
choice of prior [@kruschke2021bayesian].Once the experiment is conducted
and the posterior distribution is obtained, a check on  skewness of the
distributions, as well as heteroscedasticity. Although scale mixtures of
normal are often used in regression analysis to capture
heteroscedasticity and outlier, skew-symmetric scale mixtures of normal
(SSSM) can capture asymmetrical in addition, making it more robust to
use in BLR [@rubio2016bayesian]. The posterior distribution is where the
Markov Chain Monte Carlo (MCMC) method involves simulating random draws
from the posterior distribution, allowing for exploration of the
parameter space and estimation of the posterior distribution even in
complex, high-dimensional models [@robert2018accelerating;
@rojas2020lose]. Confirming the convergence of MCMC chains is important
for result reliability. Evidence of convergence provides confidence in
the validity of the samples[@marcotte2018gibbs]. After obtaining the
posterior results, inferences can be used for the prior distribution of
the current/next experiment [@rubio2016bayesian].

![Figure. 1 Bayesian Linear Regression Workflow](images/intro_pic.png)

To explain, posterior probabilities are assigned to the spectrum of
values that parameters can assume. The more prominent the peak, the more
effective it is as an estimate because a single value has a higher
probability compared to other values. In such cases, the credibility
interval, indicating a 95% range of probable parameter estimates, is
narrower. Conversely, when the peak is less pronounced, other estimates
are also plausible, resulting in a wider credibility interval for the
95% range of probable parameter estimates [@shetty2013evidence;
@gill2002bayesian].

Given the strengths of Bayesian linear regression, it has been used in
many disciplines. Researchers have the option to incorporate past
findings as informative priors, a practice observed in fields such as
construction and biomedicine. This analytical approach produces outcomes
that amalgamate previous results with the data from a present study,
treating it as if all existing datasets were collectively analyzed. An
example of using BLR includes determining correction coefficients to
previously inaccurate concrete mixture formulas to ensure the correct
use and amount of chemicals to prevent and then predict the breakdown of
the concrete [@zgheib2019bayesian]. Another example of BLR is
re-determining traffic-flow rate values for vehicles to ensure traffic
flow and the safe number of vehicles at intersections so that the
previous rate values from over 20 years ago could be updated
[@sugiarto2021determining]. BLR can also be used to determine the load
and strain a bridge can take before it is unsafe to be
used[@zhang2022long]. It also can be helpful to predict genetic values
for genomic selection for plants and animals to prevent the risk of
passing on genes that could cause illnesses [@perez2010genomic].

## 2. Methods

### 2.1 Linear Regression

Regression analysis is a statistical method that allows to examine the
relationship between two or more variables of interest. Suppose the
response variable $y$ is a function of several predictor variables,
$x_{i1}, x_{i2},..., x_{ik}$.

To fit a model:

$$
y = X \beta + \epsilon     \quad(1)
$$

where,

$y = (y_1, y_2,..., y_n)$ is the n×1 vector of response; $x$ is a n×p
design matrix, $p = k+1$; $\beta = (\beta_0, \beta_1,...., \beta_{k})$
is the (k+1)×1 vector of parameters and
$\epsilon = (\epsilon_1, \epsilon_2,...., \epsilon_n)$ the n×1 vector of
errors, $\epsilon$ \~ $N_n(0, \sigma^2I)$.

The likelihood function of $y$ given $\beta$ and $\sigma^2$ is defined
as follows

$$
f(Y_i = y_i|x, \beta, \sigma^2) = f_y(y|x,\beta,\sigma^2) = (2\pi\sigma^2)^{-\frac{n}{2}} exp^{-\frac{1}{2\sigma^2}(y-x\beta)^T(y-x\beta)}  \quad(2)
$$

To make inference, the $\beta$ parameters are determined by maximizing
the likelihood function.

### 2.2 Bayesian Linear Regression

From the Bayesian perspective, linear regression is approached through
probability distributions. Instead of estimating the response variable,
y, as a single value, it's viewed as being drawn from a probability
distribution. In Bayesian Linear Regression, the model assumes that the
response follows a normal distribution, expressed as

$$
y \sim N(\beta^TX, \sigma^2I)  \quad(3)
$$

where,

y, assumed as a normal distribution centered by its mean and variance.
In linear regression, the mean is calculated by the transpose of the
weight matrix and the predictor matrix. The variance is determined by
squaring the standard deviation $\sigma$ and then multiplying it by the
identity matrix.

Also, the parameters in the model are generated from a probability
distribution. The posterior probability of these parameters is
proportional to the prior and likelihood.

$$
P(\beta|y, X) = \frac{P(y|\beta, X) × P(\beta|X)}{P(y|X)}  \quad(4)
$$

In Bayesian statistics, when the prior distribution and the posterior
distribution belong to the same family of probability distributions,
they are called conjugate distributions. Using the Bayes' theorem, we
have

$$
f(\beta, \sigma^2|y,x) = \frac{f_y(y|x, \beta,\sigma^2)f(\beta|\sigma^2,m,V)f(\sigma^2|a,b)}{f_y(y)}  \quad(5)
$$

Let's break down the equation.

-   $f(\beta, \sigma^2|y,x)$: This is the joint posterior distribution
    of the coefficients $\beta$ and the error variance $\sigma^2$ given
    the data $y$ and the predictors $x$

-   $f_y(y|x, \beta,\sigma^2)$: This is the likelihood function which
    describes the probability of observing the data $y$ given the
    predictors $x$ and the parameters $\beta$ and $\sigma^2$.

-   $f(\beta|\sigma^2,m,V)$: It represents the prior distribution for
    coefficients $\beta$ given the error variance $\sigma^2$, with mean
    vector $m$ and covariance matrix $V$.

-   $f(\sigma^2|a,b)$: It represents the prior distribution for the
    error variance $\sigma^2$, which is assumed to be an inverse gamma
    distribution with parameter $a$ and $b$.

-   $f_y(y)$: It is the marginal likelihood and often treated as a
    constant.

A non-conjugate prior refers to a prior distribution that does not
belong to the same family of distributions as the posterior distribution
after observing data. In such cases, the posterior distribution can be
expressed as

$$
f(\beta|y, X, \sigma^2) ∝ f_y(y|X, \beta)\prod_{i=1}^{n}f(\beta_i|m_i,v_i)  \quad(6)
$$

-   $f(\beta|y, X, \sigma^2)$: This is the posterior distribution of
    coefficients $\beta$ given the dependent variable $y$, independent
    variable $X$ and error variance $\sigma^2$.

-   $f_y(y|X, \beta)$: This is likelihood function, denoting the
    probability of the observing data $y$ given independent variable $X$
    and the coefficient parameters $\beta$.

-   $f(\beta_i|m_i,v_i)$: This is prior distribution of each coefficient
    $\beta_i$ with mean $m_i$ and variance $v_i$.

## 3. Analysis and Results

### 3.1 Data Introduction

The selected Life Expectancy dataset from the World Health Organization
(WHO) comprises of 19 health, economic, and social factors taken from
193 countries between years 2000 and 2015, as described below:

-   **Country:** List of the 179 countries.

-   **Region:** 179 countries are distributed in 9 regions.

-   **Year:** Years observed from 2000 to 2015.

-   **Infant Deaths (InfDth):** Represents infant deaths per 1000
    population.

-   **Under_five_deaths (UnFiveDths):** Represents deaths of children
    under five years old per 1000 population.

-   **Adult Mortality (AdultMort):** Represents deaths of adults per
    1000 population.

-   **Alcohel_consumption:** Represents alcohol consumption that is
    recorded in liters of pure alcohol per capita with 15+ years old.

-   **Hepatites_B:** Represents % of coverage of Hepatitis B (HepB3)
    immunization among 1-year-olds.

-   **Measles:** Represents % of coverage of Measles containing vaccine
    first dose (MCV1) immunization among 1-year-olds.

-   **BMI:** BMI is a measure of nutritional status in adults.

-   **Polio (Pol3):** Represents % of coverage of Polio (Pol3)
    immunization among 1-year-olds.

-   **Diphtheria (DTP3):** Continuous, percentage of diphtheria tetanus
    toxoid and pertussis (DTP3) immunization coverage among 1-year-olds.

-   **Diphtheria (DTP3):** Represents % of coverage of Diphtheria
    tetanus toxoid and pertussis (DTP3) immunization among 1-year-olds.

-   **Incidents_HIV (HIVAids):** Incidents of HIV per 1000 population
    aged 15-49.

-   **GDP_per_capita (GDP):** GDP per capita in current USD.

-   **Population_mln (Population):** Total population in millions.

-   **Thinness_ten_nineteen_years (ThinAd):** Prevalence of thinness
    among adolescents aged 10-19 years

-   **Thinness_five_nine_years (ThinChild):** Prevalence of thinness
    among children aged 5-9 years.

-   **Schooling:** Average years that people aged 25+ spent in formal
    education.

-   **Life_expectancy (LifeExp):** Average life expectancy of both
    genders in different years from 2010 to 2015.

#### 3.1.1 Load the dataset and inspect the first five records.

```{r, warning=FALSE, echo=T, message=FALSE}
# loading packages 
library(tidyverse)
library(gtsummary)
library(skimr)
library(randomForest)
library(GGally)
library(corrplot)
library(car)
library(ggrepel)
```

```{r, warning=FALSE, echo=TRUE}
# Read CSV file directly from a website URL
url = "C:/Users/shiji/OneDrive/桌面/STA6257_capstone/Life-Expectancy-Data-Updated.csv"
ledata = read.csv(url, header = TRUE)
ledata <- ledata %>% select(-c('Economy_status_Developed', 'Economy_status_Developing'))

names(ledata) <- c("Country", 'Region',"Year", "InfDth","UnFiveDths","AdultMort", "Alcohol","HepB","Measles","BMI","Pol3", "DTP3", "HIVAids", "GDP", "population","ThinAd","ThinChild","Schooling", "LifeExp")
str(ledata)
```

### 3.2 Exploration Data Analysis

#### 3.2.1 Summarize the Dataset

```{r, warning=FALSE, echo=T, message=FALSE}
ledata %>% select(-c('Country', 'Year')) %>%
  tbl_summary(
    by = Region,
    label = list(InfDth ~ "Infant Deaths, per 1000",
                 UnFiveDths ~ "Deaths under 5 years of age",
                 AdultMort ~ "Adult Mortality Probability",
                 Alcohol ~ "Alcohol Consumption (L)",
                 HepB ~ "Hepatitis B Immunization (%)",
                 Measles ~ "Measles Cases per 1000",
                 BMI ~ "Average Body Mass Index", 
                 Pol3 ~ "Polio immunization (%)", 
                 DTP3 ~ "Diphtheria Tetanus Toxoid and Pertussis immunization (%)", 
                 HIVAids ~ "Deaths per 1000 live births HIV/AIDs",
                 GDP ~ "Gross Domestic Product (USD)",
                 population ~ "Total population of the country", 
                 ThinAd ~ "Thinness among 10-19 years (%)",
                 ThinChild ~ "Thinness among 5-9 years (%)",
                 Schooling ~ "Average Years of Schooling",
                 LifeExp ~ "Life Expectancy (yrs)"),
    missing_text = "(Missing)",
    statistic = list(
      all_continuous()~ "{mean} ({sd})",
      all_categorical()~ "{n}/{N} ({p}%)"
    )
  ) %>%
  add_n()%>%
  add_overall()%>%
  modify_header(label="**Variable**") %>%
  modify_caption("**Table 1. Dataset Summary**") %>%
  modify_footnote(all_stat_cols()~ "Mean (SD) or n/N(%)") %>%
  bold_labels()
```

#### 3.2.2 Verify the correlation among variables.

```{r}
ledata_noNA <- na.omit(ledata)
co_ledata <- ledata_noNA %>% select(-c('Country', 'Region', 'Year'))
cor(co_ledata)
corrplot::corrplot(cor(co_ledata), method = 'color')
```

After conducting a correlation analysis, we identified that the
variables of AdultMort, UnFiveDths and InfDth strongly associated with
Life Expectancy. The variable population is not related to
LifeExpectancy at all. We consider setting threshold of correlation
value as 0.55. Any variables' correlation with response greater than
0.55 can be included for Bayesian Linear Regression. Thus, GDP, BMI,
DTP3, Pol3, schooling, and HIVAids also can be used to predict
LifeExpectancy.

#### 3.2.3 Multicollinearity Examination

```{r}
vif_data <- ledata_noNA %>% select(-c('Year', 'Country', 'population'))
olr <- lm(LifeExp ~., data = vif_data)
vif(olr)
BLR_data <- ledata_noNA %>% select(c(AdultMort, UnFiveDths, InfDth,GDP, BMI, DTP3, Pol3, Schooling, HIVAids,LifeExp))
```

Through checking the multicollinearity among these variables, the vif
values of InfDth and UnFiveDths are slightly greater than 5, indicating
significant multicollinearity between them, but we think they are
acceptable. Thus, given the results of correlation and multicollinearity
checking, We select the independent variables of AdultMort, UnFiveDths,
InfDth,GDP, BMI, DTP3, Pol3, schooling and HIVAid and dependent variable
of LifeExpentency to contribute to our final dataset used for BLR
analysis.

#### 3.2.4 Data Visualization

```{r, warning=FALSE}
hist(ledata_noNA$LifeExp, 
     main = "Distribution of Life Expectancy",
     xlab = "Life Expectancy",
     border = "white", 
     col = "lightblue",
     ylim = c(0, 800))
```

Life Expectancy follows a distribution skewed to the left, with the peak
occurring at 70-75 years for the highest life expectancy.

```{r, warning=FALSE, message=FALSE}
# Calculate max, mean, and min life expectancy by year and region
life_expectancy_summary <- ledata_noNA %>%
  group_by(Year, Region) %>%
  summarise(
    mean_life_expectancy = mean(LifeExp) )

# Create a line plot for max, mean, and min life expectancy in all regions over the years
ggplot(life_expectancy_summary, aes(x = Year)) +
  geom_line(aes(y = mean_life_expectancy, color = Region), linetype = "solid") +
  labs(title = "Life Expectancy Over the Years by Region", x = "Year", y = "Life Expectancy", color = "Region") +
  theme_minimal() +
  scale_color_brewer(palette = "Set1") 

```

The line graph illustrates the Life Expectancy trends across various
regions over the years. There has been a consistent rise in life
expectancy across all regions since 2000. North America and European
Union exhibit the highest life expectancy, while Africa shows the lowest
among these regions.

```{r}
ledata_noNA %>% ggplot(aes(x = Schooling, y = LifeExp)) + 
  geom_point(size = 0.8, color = 'green') +
  geom_smooth()+
  theme_bw()+ 
  xlab('Average Schooling Year')

ledata_noNA %>% select(Region, Schooling, LifeExp) %>%
 group_by(Region) %>%
  summarise(Avg_Schooling = mean(Schooling),
            Avg_LifeExp = mean(LifeExp)) %>%
  ggplot(aes(x = Avg_Schooling, y = Avg_LifeExp)) +
  geom_point(size = 2.5, color = 'blue', alpha = 0.5) +
  theme_bw() +
  geom_text_repel(aes(label = Region), size = 3)

```

The graphs depict the correlation between schooling and life expectancy
across different regions. Generally, life expectancy tends to increase
with higher levels of schooling. Comparatively, more developed regions
such as North America, the European Union, and the Rest of Europe
exhibit both higher average schooling years and life expectancies.

```{r}
ledata_noNA %>% select(Region,InfDth, AdultMort, LifeExp) %>%
  ggplot(aes(x = InfDth, y = LifeExp)) + 
  geom_point(size = 0.5, color = 'orange') +
  theme_bw() +
  labs(title = 'Life Expectancy vs. InfDth')

ledata_noNA %>% select(InfDth, AdultMort, LifeExp) %>%
  ggplot(aes(x = AdultMort, y = LifeExp)) + 
  geom_point(size = 0.5, color = 'orange') +
  theme_bw() +
  labs(title = 'Life Expectancy vs. Adult Mortality')

ledata_noNA %>% 
  ggplot(aes(x = UnFiveDths, y = LifeExp)) + 
  geom_point(size = 0.5, color = 'orange') +
  theme_bw() +
  labs(title = 'Life Expectancy vs. UnderFiveDeath')
```

The graphs depict the correlation between life expectancy and the
variables AdultMort, UnFiveDths, and InfDth. All three
variables---AdultMort, UnFiveDths, and InfDth---exhibit a negative
relationship with life expectancy. As the instances of AdultMort,
UnFiveDths, and InfDth per 1000 rise, life expectancy decreases
accordingly.

```{r}
ledata_noNA %>% 
  ggplot(aes(x = BMI, y = LifeExp)) + 
  geom_point(size = 0.5, color = 'orange') +
  theme_bw() +
  geom_smooth(method = lm) +
  labs(title = 'Life Expectancy vs. BMI')

ledata_noNA %>% 
  ggplot(aes(x = GDP, y = LifeExp)) + 
  geom_point(size = 0.5, color = 'orange') +
  theme_bw() +
  geom_smooth() +
  labs(title = 'Life Expectancy vs. GDP')

ledata_noNA %>% 
  ggplot(aes(x = Pol3, y = LifeExp)) + 
  geom_point(size = 0.5, color = 'orange') +
  theme_bw() +
  geom_smooth() +
  labs(title = 'Life Expectancy vs. Diphtheria')
```

In general, a direct relationship typically exists between life
expectancy and factors such as BMI and Diphtheria immunization.
Moreover, as GDP increases, life expectancy tends to rise exponentially.
Once GDP surpasses \$30,000, the upward trend in life expectancy
continues steadily.

## Bayesian Linear Regression

### Conclusion

## References
